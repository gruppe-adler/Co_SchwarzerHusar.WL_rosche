#include "..\component.hpp"

params ["_unit", "_plane"];

private _position = _plane getRelPos [13, ((random 30) - (random 60))];
private _zPos = getPos _plane select 2;
_position set [2, _zPos];
_unit setPos _position;
_unit enableAI "MOVE";
_unit enableAI "ANIM";
removeBackpack _unit;
_unit addBackpackGlobal "NonSteerable_Parachute_F";

[{(toLower animationState _unit) in ["halofreefall_non","halofreefall_f","halofreefall_b"]}, {
    _unit allowdamage false;

    _v1 = (random 20) + 70;
    _v1 = (getDir _plane) + (round (random 8) - 4);
    _unit setVelocity [_v1 * (sin _v1), _v1 * (cos _v1), -15 ];

    private _chute = createVehicle ['NonSteerable_Parachute_F', position _unit,[],0,'Fly'];
    _chute setPos position _unit;
    _unit moveIndriver _chute; 
    _chute allowDamage false;

    _unit setVariable ["GRAD_drop_dropped", true];

    [{
        isTouchingGround _unit
    },{
        params ["_unit"];
        _unit allowdamage true;    
    }, [_unit]] call CBA_fnc_waitUntilAndExecute;

}, _this,900,{}] call CBA_fnc_waitUntilAndExecute;